<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Image Editor</title>
    <style>
        :root {
            --bg-color: #1a202c;
            --text-color: #ffffff;
            --primary-color: #3182ce;
            --secondary-color: #4a5568;
            --accent-color: #68d391;
            --error-color: #fc8181;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .image-container {
            aspect-ratio: 16/9;
            background-color: var(--secondary-color);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }

        .image-container img, .image-container canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .upload-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
        }

        .upload-input {
            display: none;
        }

        .button {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #2c5282;
        }

        .button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .gallery-item {
            aspect-ratio: 1;
            background-color: var(--secondary-color);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .toolbar {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .tool {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: background-color 0.3s;
        }

        .tool.active {
            background-color: var(--primary-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--secondary-color);
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
        }

        #errorMessage {
            color: var(--error-color);
            margin-top: 10px;
            text-align: center;
        }

        .text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .text-element {
            position: absolute;
            cursor: move;
            user-select: none;
            padding: 2px;
            border: 1px solid transparent;
        }

        .text-element:hover, .text-element.selected {
            border-color: var(--primary-color);
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        #zoomControls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        #historyPanel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: var(--secondary-color);
            transition: right 0.3s;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        #historyPanel.open {
            right: 0;
        }

        .history-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid var(--primary-color);
        }

        .history-item:hover {
            background-color: var(--primary-color);
        }

        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 5px solid var(--secondary-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #darkModeToggle {
            position: fixed;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
    </div>

    <button id="darkModeToggle" class="button">Toggle Dark Mode</button>

    <div class="container">
        <div id="authContainer">
            <button id="loginButton" class="button tooltip">Login
                <span class="tooltiptext">Log in to save and share your edits</span>
            </button>
            <span id="principalId"></span>
        </div>
        <div class="controls">
            <div>
                <button id="undoButton" class="button tooltip" disabled>Undo
                    <span class="tooltiptext">Undo last action (Ctrl+Z)</span>
                </button>
                <button id="redoButton" class="button tooltip" disabled>Redo
                    <span class="tooltiptext">Redo last undone action (Ctrl+Y)</span>
                </button>
                <button id="resetButton" class="button tooltip" disabled>Reset
                    <span class="tooltiptext">Reset all changes</span>
                </button>
                <button id="saveButton" class="button tooltip" disabled>Save
                    <span class="tooltiptext">Save your edited image</span>
                </button>
                <button id="shareButton" class="button tooltip" disabled>Share
                    <span class="tooltiptext">Share your edited image</span>
                </button>
                <button id="exportButton" class="button tooltip" disabled>Export
                    <span class="tooltiptext">Export your edited image</span>
                </button>
                <button id="historyButton" class="button tooltip">History
                    <span class="tooltiptext">View edit history</span>
                </button>
            </div>
        </div>
        
        <div class="toolbar">
            <button class="tool tooltip" data-tool="brush">Brush
                <span class="tooltiptext">Draw on the image</span>
            </button>
            <button class="tool tooltip" data-tool="eraser">Eraser
                <span class="tooltiptext">Erase parts of the image</span>
            </button>
            <button class="tool tooltip" data-tool="text">Text
                <span class="tooltiptext">Add text to the image</span>
            </button>
            <button class="tool tooltip" data-tool="crop">Crop
                <span class="tooltiptext">Crop the image</span>
            </button>
            <button class="tool tooltip" data-tool="rotate">Rotate
                <span class="tooltiptext">Rotate the image</span>
            </button>
            <button class="tool tooltip" data-tool="resize">Resize
                <span class="tooltiptext">Resize the image</span>
            </button>
            <button class="tool tooltip" data-tool="filter">Filters
                <span class="tooltiptext">Apply filters to the image</span>
            </button>
            <input type="color" id="colorPicker" class="tooltip">
                <span class="tooltiptext">Choose color for brush or text</span>
            </input>
        </div>
        
        <div class="image-container" id="imageContainer">
            <canvas id="canvas"></canvas>
            <div class="text-overlay" id="textOverlay"></div>
            <label class="upload-label" id="uploadLabel">
                Upload Image
                <input type="file" accept="image/*" class="upload-input" id="imageUpload">
            </label>
            <div id="zoomControls">
                <button id="zoomIn" class="button">+</button>
                <button id="zoomOut" class="button">-</button>
                <span id="zoomLevel">100%</span>
            </div>
        </div>

        <div id="errorMessage"></div>

        <div class="gallery" id="gallery"></div>
    </div>

    <div id="historyPanel">
        <h3>Edit History</h3>
        <div id="historyList"></div>
    </div>

    <div id="textModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Text</h2>
            <input type="text" id="textInput" placeholder="Enter text">
            <input type="color" id="textColor" value="#000000">
            <input type="number" id="textSize" min="10" max="100" value="30">
            <button id="addTextButton" class="button">Add Text</button>
        </div>
    </div>

    <div id="resizeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Resize Image</h2>
            <input type="number" id="widthInput" placeholder="Width">
            <input type="number" id="heightInput" placeholder="Height">
            <button id="resizeButton" class="button">Resize</button>
        </div>
    </div>

    <div id="filterModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Apply Filter</h2>
            <div id="filterPreview"></div>
            <button class="button" data-filter="grayscale">Grayscale</button>
            <button class="button" data-filter="sepia">Sepia</button>
            <button class="button" data-filter="invert">Invert</button>
            <button id="applyFilterButton" class="button">Apply</button>
        </div>
    </div>

    <div id="cropModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Crop Image</h2>
            <select id="aspectRatio">
                <option value="free">Free</option>
                <option value="1:1">1:1</option>
                <option value="4:3">4:3</option>
                <option value="16:9">16:9</option>
            </select>
            <button id="applyCropButton" class="button">Apply Crop</button>
        </div>
    </div>

    <script type="module">
        import { AuthClient } from "@dfinity/auth-client";
        import { Actor, HttpAgent } from "@dfinity/agent";

        let authClient;
        let actor;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageUpload = document.getElementById('imageUpload');
        const uploadLabel = document.getElementById('uploadLabel');
        const undoButton = document.getElementById('undoButton');
        const redoButton = document.getElementById('redoButton');
        const resetButton = document.getElementById('resetButton');
        const saveButton = document.getElementById('saveButton');
        const shareButton = document.getElementById('shareButton');
        const exportButton = document.getElementById('exportButton');
        const historyButton = document.getElementById('historyButton');
        const gallery = document.getElementById('gallery');
        const loginButton = document.getElementById('loginButton');
        const principalId = document.getElementById('principalId');
        const tools = document.querySelectorAll('.tool');
        const textModal = document.getElementById('textModal');
        const resizeModal = document.getElementById('resizeModal');
        const filterModal = document.getElementById('filterModal');
        const cropModal = document.getElementById('cropModal');
        const errorMessage = document.getElementById('errorMessage');
        const textOverlay = document.getElementById('textOverlay');
        const colorPicker = document.getElementById('colorPicker');
        const zoomIn = document.getElementById('zoomIn');
        const zoomOut = document.getElementById('zoomOut');
        const zoomLevel = document.getElementById('zoomLevel');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const loading = document.getElementById('loading');
        const darkModeToggle = document.getElementById('darkModeToggle');

        let currentImage = null;
        let editHistory = [];
        let currentEditIndex = -1;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentTool = 'brush';
        let textElements = [];
        let isDraggingText = false;
        let selectedTextIndex = -1;
        let zoom = 1;
        let isDarkMode = false;

        const backendCanisterIdEnvVar = 'BACKEND_CANISTER_ID';
        const backendCanisterId = process.env[backendCanisterIdEnvVar] || '';

        const idlFactory = ({ IDL }) => {
            return IDL.Service({
                'uploadImage': IDL.Func([IDL.Text, IDL.Vec(IDL.Nat8)], [IDL.Variant({ 'ok' : IDL.Null, 'err' : IDL.Text })], []),
                'getImage': IDL.Func([IDL.Text], [IDL.Variant({ 'ok' : IDL.Vec(IDL.Nat8), 'err' : IDL.Text })], ['query']),
                'listImages': IDL.Func([], [IDL.Vec(IDL.Text)], ['query']),
                'deleteImage': IDL.Func([IDL.Text], [IDL.Variant({ 'ok' : IDL.Null, 'err' : IDL.Text })], [])
            });
        };

        async function initAuth() {
            authClient = await AuthClient.create();
            if (await authClient.isAuthenticated()) {
                handleAuthenticated();
            }
        }

        async function login() {
            try {
                await authClient.login({
                    identityProvider: "https://identity.ic0.app/#authorize",
                    onSuccess: handleAuthenticated,
                });
            } catch (error) {
                console.error("Login failed:", error);
                showError("Login failed. Please try again.");
            }
        }

        async function handleAuthenticated() {
            const identity = await authClient.getIdentity();
            principalId.textContent = identity.getPrincipal().toText();
            loginButton.style.display = 'none';

            const agent = new HttpAgent({ identity });
            actor = Actor.createActor(idlFactory, {
                agent,
                canisterId: backendCanisterId,
            });

            loadGallery();
            enableButtons();
        }

        function enableButtons() {
            saveButton.disabled = false;
            shareButton.disabled = false;
            exportButton.disabled = false;
        }

        loginButton.onclick = login;

        function handleImageUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    currentImage = canvas.toDataURL();
                    saveEditState();
                    uploadLabel.style.display = 'none';
                    enableButtons();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveEditState() {
            editHistory = editHistory.slice(0, currentEditIndex + 1);
            editHistory.push({
                imageData: canvas.toDataURL(),
                textElements: JSON.parse(JSON.stringify(textElements))
            });
            currentEditIndex = editHistory.length - 1;
            updateUndoRedoButtons();
            updateHistoryPanel();
        }

        function updateUndoRedoButtons() {
            undoButton.disabled = currentEditIndex <= 0;
            redoButton.disabled = currentEditIndex >= editHistory.length - 1;
        }

        function undo() {
            if (currentEditIndex > 0) {
                currentEditIndex--;
                loadEditState(editHistory[currentEditIndex]);
                updateUndoRedoButtons();
            }
        }

        function redo() {
            if (currentEditIndex < editHistory.length - 1) {
                currentEditIndex++;
                loadEditState(editHistory[currentEditIndex]);
                updateUndoRedoButtons();
            }
        }

        function reset() {
            if (currentImage) {
                if (confirm("Are you sure you want to reset all changes?")) {
                    loadImageFromDataURL(currentImage);
                    textElements = [];
                    updateTextOverlay();
                    saveEditState();
                }
            }
        }

        function loadEditState(state) {
            loadImageFromDataURL(state.imageData);
            textElements = state.textElements;
            updateTextOverlay();
        }

        function loadImageFromDataURL(dataURL) {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = dataURL;
        }

        function updateTextOverlay() {
            textOverlay.innerHTML = '';
            textElements.forEach((element, index) => {
                const textElement = document.createElement('div');
                textElement.className = 'text-element';
                textElement.style.left = `${element.x}px`;
                textElement.style.top = `${element.y}px`;
                textElement.style.color = element.color;
                textElement.style.fontSize = `${element.size}px`;
                textElement.textContent = element.text;
                textElement.dataset.index = index;
                textElement.addEventListener('mousedown', startDraggingText);
                textOverlay.appendChild(textElement);
            });
        }

        async function saveImage() {
            if (!canvas.toDataURL()) return;
            if (!actor) {
                showError("Please login before saving.");
                return;
            }

            showLoading();
            try {
                const blob = await new Promise(resolve => {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(canvas, 0, 0);
                    textElements.forEach(element => {
                        tempCtx.font = `${element.size}px Arial`;
                        tempCtx.fillStyle = element.color;
                        tempCtx.fillText(element.text, element.x, element.y);
                    });
                    tempCanvas.toBlob(resolve, 'image/png');
                });
                const arrayBuffer = await blob.arrayBuffer();
                const name = `image_${Date.now()}.png`;

                await actor.uploadImage(name, [...new Uint8Array(arrayBuffer)]);
                showError('Image saved successfully!', false);
                loadGallery();
            } catch (error) {
                console.error('Error saving image:', error);
                showError('Failed to save image. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function loadGallery() {
            showLoading();
            try {
                const imageNames = await actor.listImages();
                gallery.innerHTML = '';
                for (const name of imageNames) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(new Blob([await actor.getImage(name)], { type: 'image/png' }));
                    img.alt = name;
                    img.onclick = () => loadImageFromGallery(name);
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    galleryItem.appendChild(img);
                    gallery.appendChild(galleryItem);
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
                showError('Failed to load gallery. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function loadImageFromGallery(name) {
            showLoading();
            try {
                const imageBlob = await actor.getImage(name);
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    currentImage = canvas.toDataURL();
                    textElements = [];
                    updateTextOverlay();
                    saveEditState();
                    uploadLabel.style.display = 'none';
                    enableButtons();
                    hideLoading();
                };
                img.src = URL.createObjectURL(new Blob([imageBlob], { type: 'image/png' }));
            } catch (error) {
                console.error('Error loading image from gallery:', error);
                showError('Failed to load image. Please try again.');
                hideLoading();
            }
        }

        function shareImage() {
            if (!canvas.toDataURL()) return;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            textElements.forEach(element => {
                tempCtx.font = `${element.size}px Arial`;
                tempCtx.fillStyle = element.color;
                tempCtx.fillText(element.text, element.x, element.y);
            });
            tempCanvas.toBlob(blob => {
                const file = new File([blob], "edited_image.png", { type: "image/png" });
                const shareData = {
                    files: [file],
                };
                if (navigator.share && navigator.canShare(shareData)) {
                    navigator.share(shareData)
                        .then(() => console.log('Image shared successfully'))
                        .catch((error) => {
                            if (error.name !== 'AbortError') {
                                console.error('Error sharing image:', error);
                                showError('Failed to share image. Please try again.');
                            }
                        });
                } else {
                    showError('Sharing is not supported on this device/browser');
                }
            }, 'image/png');
        }

        function exportImage() {
            if (!canvas.toDataURL()) return;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            textElements.forEach(element => {
                tempCtx.font = `${element.size}px Arial`;
                tempCtx.fillStyle = element.color;
                tempCtx.fillText(element.text, element.x, element.y);
            });
            const link = document.createElement('a');
            link.download = 'edited_image.png';
            link.href = tempCanvas.toDataURL();
            link.click();
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX / zoom, e.offsetY / zoom];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX / zoom, e.offsetY / zoom);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX / zoom, e.offsetY / zoom];
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveEditState();
            }
        }

        function setActiveTool(tool) {
            currentTool = tool;
            tools.forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');

            switch(tool) {
                case 'brush':
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = colorPicker.value;
                    ctx.lineWidth = 5;
                    break;
                case 'eraser':
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 20;
                    break;
                case 'text':
                    textModal.style.display = 'block';
                    break;
                case 'crop':
                    cropModal.style.display = 'block';
                    break;
                case 'rotate':
                    rotateImage();
                    break;
                case 'resize':
                    resizeModal.style.display = 'block';
                    break;
                case 'filter':
                    filterModal.style.display = 'block';
                    updateFilterPreview();
                    break;
            }
        }

        function addText() {
            const text = document.getElementById('textInput').value;
            const color = document.getElementById('textColor').value;
            const size = parseInt(document.getElementById('textSize').value);
            if (text) {
                textElements.push({
                    text,
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    color,
                    size
                });
                updateTextOverlay();
                saveEditState();
            }
            textModal.style.display = 'none';
        }

        function rotateImage() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.height;
            tempCanvas.height = canvas.width;
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(Math.PI / 2);
            tempCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            saveEditState();
        }

        function resizeImage() {
            const width = parseInt(document.getElementById('widthInput').value);
            const height = parseInt(document.getElementById('heightInput').value);
            if (width && height) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = width;
                tempCanvas.height = height;
                tempCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, width, height);
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(tempCanvas, 0, 0);
                saveEditState();
            }
            resizeModal.style.display = 'none';
        }

        function updateFilterPreview() {
            const previewCanvas = document.createElement('canvas');
            const previewCtx = previewCanvas.getContext('2d');
            previewCanvas.width = 200;
            previewCanvas.height = 200;
            const aspectRatio = canvas.width / canvas.height;
            let previewWidth, previewHeight;
            if (aspectRatio > 1) {
                previewWidth = 200;
                previewHeight = 200 / aspectRatio;
            } else {
                previewHeight = 200;
                previewWidth = 200 * aspectRatio;
            }
            previewCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, previewWidth, previewHeight);
            document.getElementById('filterPreview').innerHTML = '';
            document.getElementById('filterPreview').appendChild(previewCanvas);
        }

        function applyFilter(filter) {
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            switch(filter) {
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        let avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = data[i + 1] = data[i + 2] = avg;
                    }
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        let r = data[i], g = data[i + 1], b = data[i + 2];
                        data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                        data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                        data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                    }
                    break;
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i + 1] = 255 - data[i + 1];
                        data[i + 2] = 255 - data[i + 2];
                    }
                    break;
            }
            ctx.putImageData(imageData, 0, 0);
            saveEditState();
            filterModal.style.display = 'none';
        }

        function showError(message, isError = true) {
            errorMessage.textContent = message;
            errorMessage.style.color = isError ? 'var(--error-color)' : 'var(--accent-color)';
            setTimeout(() => {
                errorMessage.textContent = '';
            }, 3000);
        }

        function startDraggingText(e) {
            isDraggingText = true;
            selectedTextIndex = parseInt(e.target.dataset.index);
            lastX = e.clientX;
            lastY = e.clientY;
            document.addEventListener('mousemove', dragText);
            document.addEventListener('mouseup', stopDraggingText);
        }

        function dragText(e) {
            if (!isDraggingText) return;
            const dx = (e.clientX - lastX) / zoom;
            const dy = (e.clientY - lastY) / zoom;
            
            textElements[selectedTextIndex].x += dx;
            textElements[selectedTextIndex].y += dy;
            
            lastX = e.clientX;
            lastY = e.clientY;
            
            updateTextOverlay();
        }

        function stopDraggingText() {
            if (isDraggingText) {
                isDraggingText = false;
                saveEditState();
                document.removeEventListener('mousemove', dragText);
                document.removeEventListener('mouseup', stopDraggingText);
            }
        }

        function updateZoom(delta) {
            zoom = Math.max(0.1, Math.min(5, zoom + delta));
            zoomLevel.textContent = `${Math.round(zoom * 100)}%`;
            canvas.style.transform = `scale(${zoom})`;
            canvas.style.transformOrigin = 'top left';
        }

        function updateHistoryPanel() {
            historyList.innerHTML = '';
            editHistory.forEach((state, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.textContent = `Edit ${index + 1}`;
                historyItem.onclick = () => {
                    currentEditIndex = index;
                    loadEditState(state);
                    updateUndoRedoButtons();
                };
                historyList.appendChild(historyItem);
            });
        }

        function showLoading() {
            loading.style.display = 'flex';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.style.setProperty('--bg-color', isDarkMode ? '#1a202c' : '#ffffff');
            document.body.style.setProperty('--text-color', isDarkMode ? '#ffffff' : '#000000');
        }

        imageUpload.addEventListener('change', handleImageUpload);
        undoButton.addEventListener('click', undo);
        redoButton.addEventListener('click', redo);
        resetButton.addEventListener('click', reset);
        saveButton.addEventListener('click', saveImage);
        shareButton.addEventListener('click', shareImage);
        exportButton.addEventListener('click', exportImage);
        historyButton.addEventListener('click', () => historyPanel.classList.toggle('open'));
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        tools.forEach(tool => tool.addEventListener('click', () => setActiveTool(tool.dataset.tool)));
        document.getElementById('addTextButton').addEventListener('click', addText);
        document.getElementById('resizeButton').addEventListener('click', resizeImage);
        document.getElementById('applyFilterButton').addEventListener('click', () => applyFilter(document.querySelector('#filterModal .button.active').dataset.filter));
        document.querySelectorAll('#filterModal .button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('#filterModal .button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                applyFilter(e.target.dataset.filter);
                updateFilterPreview();
            });
        });
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => closeBtn.closest('.modal').style.display = 'none');
        });
        colorPicker.addEventListener('change', () => {
            if (currentTool === 'brush') {
                ctx.strokeStyle = colorPicker.value;
            }
        });
        zoomIn.addEventListener('click', () => updateZoom(0.1));
        zoomOut.addEventListener('click', () => updateZoom(-0.1));
        darkModeToggle.addEventListener('click', toggleDarkMode);

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') {
                undo();
            } else if (e.ctrlKey && e.key === 'y') {
                redo();
            }
        });

        initAuth();
    </script>
</body>
</html>
